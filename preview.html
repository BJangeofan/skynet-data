<!doctype html>
<html>
  <head>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.16.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.16.0/mapbox-gl.css' rel='stylesheet' />
    <style>
      body { margin:0; padding:0; }
      ul { list-style-type: none; position: absolute; top: 0; bottom: 0; left: 0; width: 30%; overflow: scroll; }
      li { margin-bottom: 20px; }
      li img { width: 49%; }
      #map { position:absolute; top:0; bottom:0; right: 0; width: 65%; }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      var query = {}
      window.location.search.substring(1).split('&').forEach(function (p) {
        p = p.split('=')
        query[p[0]] = p[1]
      })
      query = Object.assign({
        images: 'data/images/',
        labels: 'data/labels/color/',
        sample: 'data/sample.txt'
      }, query)

      // map
      mapboxgl.accessToken = query.accessToken
      var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/satellite-v8',
        center: [-74.50, 40],
        zoom: 9
      })

      // grab tile list and show images + labels side by side
      fetch(query.sample)
      .then(function (response) { return response.text() })
      .then(function (text) {
        var lines = text.trim().split('\n')
        .map(function (line) {
          if (line.startsWith('#')) { return null }
          var tile = line.split(' ').slice(1, 4).map(Number)
          var lonlat = [tile2long(tile[1], tile[0]), tile2lat(tile[2], tile[0])].map(function (c) { return c.toFixed(4) })
          return `
          <li data-location="${lonlat}" data-zoom="${tile[0]}">
            <img src="${query.images}${tile.join('-')}.png">
            <img src="${query.labels}${tile.join('-')}.png">
            <div>${tile} (${lonlat.reverse()})</div>
          </li>
          `
        })
        .filter(Boolean)

        document.querySelector('ul').innerHTML += lines.join('\n')
        var items = document.querySelectorAll('li')
        for (var i = 0; i < items.length; i++) {
          var li = items[i]
          li.addEventListener('click', onClick)
          li.addEventListener('mouseover', onHover);
        }
      })

      function onClick (e) {
        var ll = e.currentTarget.dataset.location.split(',').map(Number)
        var z = +e.currentTarget.dataset.zoom
        map.flyTo({center: ll, zoom: z - 1, speed: 2})
      }
      function onHover (e) {
        var ll = e.currentTarget.dataset.location.split(',').map(Number)
      }
      function tile2long(x,z) { return (x/Math.pow(2,z)*360-180); }
      function tile2lat(y,z) {
       var n=Math.PI-2*Math.PI*y/Math.pow(2,z);
       return (180/Math.PI*Math.atan(0.5*(Math.exp(n)-Math.exp(-n))));
      }
    </script>
  </body>
  <ul></ul>
</html>
